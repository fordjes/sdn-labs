---
date: "2016-11-29"
draft: false
weight: 340
title: "Lab 16 - PacketIn Hub logic with an SDN (Ryu)"
---
[Click here to find out more about Alta3 Research's SDN Training](https://alta3.com/courses/sdn)

### WEDNESDAY - &#x2B50;REQUIRED&#x2B50;

### Lab Objective
The objective of this lab is to understand and demonstrate basic PacketIn and PacketOut OpenFlow mechanisms in a simple flooding switch (hub).

### Procedure

0. Once again, over the next few steps, you'll be asked to augment *fi.py* to become *hub.py*. Again. Do your best here. If your code doesn't run, you can issue a *wget* statement and download a working version. 

    `student@beachhead:~$` `cp fi.py hub.py`

0. We're going to use the *vim* editor to tweak our new file, *hub.py*. Remember, if you mess this up, you can always *wget* a working version. 

    `student@beachhead:~$` `vim hub.py`

0. Press the **i** key to enter *--INSERT--* mode.

0. Delete the word *return* on *line 57* (this is the last line in *hub.py*)

0. Just as you did before, copy and paste the following code skeleton onto *line 57*. Each of these code comments should be proceeded by 4 spaces.

    ```
        # Handle packet in event
        @set_ev_cls(ofp_event.EventOFPPacketIn, MAIN_DISPATCHER)
        def packet_in_handler(self, ev):

          # register values into shorter variable names

          # create flood action

          # create response to packetin

          # actually send the packet to the requesting switch
    ```

0. We will add the below python sections to `hub.py` in order to create a simple flooding hub.  For each section below, find the comment from the skeleton and add the python code.

0. Create a set of shortened variable names for future use

  ```
				# register values into shorter variable names
				msg = ev.msg
				dp = msg.datapath
				ofp = dp.ofproto
				ofp_parser = dp.ofproto_parser
  ```

0. Create a flood action.  This tells the switch to send the packet which it asked the controller about to all ports on the switch except the one it came in on.

  ```
				# create flood action
				actions = [ofp_parser.OFPActionOutput(ofp.OFPP_FLOOD)]
	```

0. Create the response packet which will get sent to the switch containing all the values we setup

  ```
				# create response to packetin
				out = ofp_parser.OFPPacketOut(
						datapath=dp,
						buffer_id=msg.buffer_id,
						in_port=msg.match['in_port'],
						actions=actions
				)
  ```

0. Send the resulting `PacketOut` 

  ```
				# actually send the packet to the requesting switch
				dp.send_msg(out)
  ```

0. Startup Wireshark and capture the packets which flow to/from the controller in this setup. This will require the use of three (3) separate terminal windows. The one we are currently using, we'll call *Terminal1*. Type the following in *Terminal1* to launch Wireshark.

    `student@beachhead:~$` `sudo wireshark &`

0. Without closing the first terminal (*Terminal1*), open a second terminal (*Terminal2*). In the new second terminal, type the following. If your code doesn't run, **KEEP READING** for two common solutions:

    `student@beachhead:/$` `ryu-manager ~/hub.py`
    
    - If the above commands fail, you can try to issue `pkill -f ovs-testcontroller` as sometimes ovs-testcontroller is left on, and operating on the port 6653
    - If is possible your code was put together improperly. If you read the errors, its possible you can figure it out. Usually it is a indentation error. If you still can't figure it out, issue the follow command, then try again: `wget -O ~/hub.py https://alta3.com/labs/files/hub.py`
    
0. Without closing the first terminal (*Terminal1*) or the second terminal (*Terminal2*), open a third terminal (*Terminal3*). In the new third terminal, type the following:

    `student@beachhead:/$` `sudo mn --controller=remote,ip=127.0.0.1,port=6653`

0. Answer the below questions about the Wireshark capture:

    - **Q1: What new packets are coming fromt he switch as a result of the changes we made?**
      - A1: PACKET_OUT
    - **Q3: If we ran `pingall` inside Mininet would we see a PACKET_IN / PACKET_OUT message to the controller?**
      - A3: 
    - **Q4: Why or why not?**
      - A4: 
    - **Q5: Why is this method of packet handeling inefficient?**
      - A5:
    - **Q6: How could we make a better hub (without any mac address learning)?**
      - A6:

0. Time to cleanup! First close Wireshark. Then in the terminal window you used to launch Wireshark (*terminal1*), type:

    `student@beachhead:~$` `exit`

0. In the terminal window you used to run the ryu-manager, (*terminal2*), press ** Ctrl + C** to stop ryu-manager.

    `student@beachhead:/$` `exit`

0. Now close the terminal window you used to launch ryu-manager.

0. Finally, in the mininet window (*terminal3*), type:

    `mininet> exit`
  
0. Then make sure mininet has exited all processes properly.

    `student@beachhead:/$` `sudo mn --clean`

0. Finally, close the last terminal.

    `student@beachhead:~$` `exit`
  
0. Great job! That's it for this lab.
